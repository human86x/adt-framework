{% extends "base.html" %}
{% set active_page = "specs" %}

{% block title %}Spec Registry - ADT Operational Center{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h5 class="mb-0" style="font-size:1rem; font-weight:600;">Specification Registry</h5>
        <span class="text-adt-muted" style="font-size:0.8rem;">
            {{ specs|selectattr('status', 'equalto', 'APPROVED')|list|length }} approved &middot;
            {{ specs|length }} total
        </span>
    </div>
    <button class="btn-adt-primary" data-bs-toggle="modal" data-bs-target="#createSpecModal">
        <span class="me-1">+</span> Create Spec
    </button>
</div>

<div class="row g-3">
    {% for spec in specs %}
    <div class="col-12">
        <div class="card card-adt">
            <div class="card-header d-flex justify-content-between align-items-center"
                 style="cursor:pointer;"
                 data-status="{{ spec.status|upper }}"
                 onclick="viewSpec('{{ spec.id }}', '{{ spec.name }}', this)">
                <div>
                    <span class="text-adt-accent fw-bold">{{ spec.id }}</span>
                    <span class="ms-2">{{ spec.name }}</span>
                </div>
                <div class="d-flex align-items-center">
                    {% if spec.status|upper == 'DRAFT' %}
                    <button class="btn btn-success btn-sm me-2" style="font-size:0.65rem; padding:0.1rem 0.4rem;" 
                            onclick="event.stopPropagation(); updateStatusDirect('{{ spec.id }}', 'APPROVED')">
                        Approve
                    </button>
                    {% elif spec.status|upper == 'APPROVED' or spec.status|upper == 'ACTIVE' %}
                    <button class="btn btn-purple btn-sm me-2" style="font-size:0.65rem; padding:0.1rem 0.4rem;" 
                            onclick="event.stopPropagation(); updateStatusDirect('{{ spec.id }}', 'COMPLETED')">
                        Complete
                    </button>
                    {% endif %}
                    <span class="badge-adt me-3 {% if spec.status|upper == 'APPROVED' %}badge-completed{% elif spec.status|upper == 'DRAFT' %}badge-pending{% else %}badge-in-progress{% endif %}" 
                          data-spec-id="{{ spec.id }}">
                        {% if spec.status|upper == 'APPROVED' %}
                        <i class="bi bi-patch-check-fill me-1"></i>
                        {% elif spec.status|upper == 'DRAFT' %}
                        <i class="bi bi-clock-history me-1"></i>
                        {% endif %}
                        {{ spec.status|upper }}
                    </span>
                    <span class="text-adt-muted d-none d-md-inline" style="font-size:0.7rem;">Click to open &#8599;</span>
                </div>
            </div>
            {# Hidden storage for rendered markdown #}
            <div id="data-{{ spec.id }}" style="display:none;">
                {% if spec.content %}
                {{ spec.content|markdown }}
                {% else %}
                <p class="text-adt-muted">Spec content not available.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Spec Viewer Modal -->
<div class="modal fade modal-adt" id="specModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="specModalTitle">
                    <span id="m-spec-id" class="text-adt-accent"></span>
                    <span id="m-spec-name" class="ms-2"></span>
                    <span id="m-spec-status" class="badge-adt ms-2" style="font-size:0.7rem;"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="specModalBody" class="modal-spec-viewer">
                    <!-- Content injected here -->
                </div>
            </div>
            <div class="modal-footer border-adt d-flex justify-content-between">
                <div>
                    <button type="button" id="btn-approve-spec" class="btn btn-sm btn-success d-none" onclick="updateStatus('APPROVED')">
                        <i class="bi bi-patch-check-fill me-1"></i> Approve Spec
                    </button>
                    <button type="button" id="btn-complete-spec" class="btn btn-sm btn-purple d-none" onclick="updateStatus('COMPLETED')">
                        <i class="bi bi-check-all me-1"></i> Mark Complete
                    </button>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Spec Modal -->
<div class="modal fade modal-adt" id="createSpecModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Specification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createSpecForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label-adt">Spec ID</label>
                            <input type="text" id="spec-id" class="form-control-adt" placeholder="SPEC-026" required>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label-adt">Title</label>
                            <input type="text" id="spec-title" class="form-control-adt" placeholder="New Feature Idea" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label-adt">Content (Markdown)</label>
                            <textarea id="spec-content" class="form-control-adt" rows="12" style="font-family:monospace; font-size:0.8rem;" placeholder="# SPEC-XXX: Title\n\n## Purpose\n..." required></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-adt">
                    <button type="button" class="btn btn-sm btn-adt-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-adt-primary">Create Specification</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function viewSpec(id, name, el) {
    const content = document.getElementById('data-' + id).innerHTML;
    const currentStatus = el.getAttribute('data-status') || 'DRAFT';

    document.getElementById('m-spec-id').innerText = id;
    document.getElementById('m-spec-name').innerText = name;
    document.getElementById('m-spec-status').innerText = currentStatus;
    document.getElementById('specModalBody').innerHTML = content;
    
    // Toggle buttons based on status
    const approveBtn = document.getElementById('btn-approve-spec');
    const completeBtn = document.getElementById('btn-complete-spec');
    
    approveBtn.classList.add('d-none');
    completeBtn.classList.add('d-none');
    
    if (currentStatus === 'DRAFT') {
        approveBtn.classList.remove('d-none');
    } else if (currentStatus === 'APPROVED' || currentStatus === 'ACTIVE') {
        completeBtn.classList.remove('d-none');
    }
    
    const myModal = new bootstrap.Modal(document.getElementById('specModal'));
    myModal.show();
}

async function updateStatusDirect(specId, newStatus) {
    if (!confirm(`Are you sure you want to change Spec ${specId} status to ${newStatus}?`)) return;
    await performUpdate(specId, newStatus);
}

async function updateStatus(newStatus) {
    const specId = document.getElementById('m-spec-id').innerText;
    if (!confirm(`Are you sure you want to change Spec ${specId} status to ${newStatus}?`)) return;
    await performUpdate(specId, newStatus);
}

async function performUpdate(specId, newStatus) {
    const urlParams = new URLSearchParams(window.location.search);
    const project = urlParams.get('project');
    
    try {
        const query = project ? `?project=${project}` : '';
        const res = await fetch(`/api/specs/${specId}/status${query}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (res.ok) {
            location.reload();
        } else {
            const err = await res.json();
            alert('Error: ' + err.error);
        }
    } catch (e) {
        alert('Failed to update status');
    }
}

document.getElementById('createSpecForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        id: document.getElementById('spec-id').value,
        title: document.getElementById('spec-title').value,
        status: 'DRAFT',
        content: document.getElementById('spec-content').value
    };

    try {
        const res = await fetch('/api/specs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
            alert('Spec created successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (err) {
        alert('Failed to connect to API');
    }
});
</script>
{% endblock %}"