{% extends "base.html" %}
{% set active_page = "governance" %}

{% block title %}Governance - ADT Operational Center{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Left Column: Authorizations & Role Manager -->
    <div class="col-lg-8">
        <!-- SPEC-033: Pending Authorizations -->
        <div id="scr-section" class="mb-5 d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0" style="font-size:1.1rem; font-weight:700; color:var(--adt-amber);">
                    &#9888; Pending Authorizations
                </h5>
                <span id="scr-count-badge" class="badge rounded-pill bg-danger">0</span>
            </div>
            <div id="scr-container" class="row g-3">
                <!-- SCR cards injected by JS -->
            </div>
            <hr class="border-adt my-4">
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0" style="font-size:1rem; font-weight:600;">Role Jurisdiction Manager</h5>
            <span class="badge-adt badge-completed">HUMAN-ONLY ACCESS</span>
        </div>

        <div id="role-cards-container" class="row g-3">
            <!-- Role cards will be injected by JS -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-accent" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-adt-muted">Fetching governance configuration...</p>
            </div>
        </div>
    </div>

    <!-- Right Column: Enforcement Dashboard -->
    <div class="col-lg-4">
        <div class="section-title">Enforcement Dashboard</div>
        
        <div class="card card-adt mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>DTTP Status</span>
                <span id="enforcement-mode-badge" class="badge-adt">--</span>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div id="dttp-indicator" class="status-dot me-2"></div>
                    <span id="dttp-status-text">Checking DTTP service...</span>
                </div>
                
                <div class="mb-2">
                    <label class="form-label-adt">Protected Paths (Read-Only)</label>
                    <div id="protected-paths-list" class="adt-spec-content" style="max-height: 200px; overflow-y: auto;">
                        <!-- Paths injected by JS -->
                        <p class="text-adt-muted small">Loading protected paths...</p>
                    </div>
                </div>

                <div id="conflicts-container" class="mt-3 d-none">
                    <label class="form-label-adt text-adt-red">Governance Conflicts Detected</label>
                    <ul id="conflicts-list" class="list-unstyled small text-adt-red mb-0"></ul>
                </div>

                <hr class="border-adt">
                
                <div class="text-center mt-3">
                    <label class="form-label-adt mb-2">Emergency Override</label>
                    <button id="btn-shatterglass" class="btn btn-lg w-100 btn-outline-danger fw-bold" onclick="openShatterglass()">
                        &#9889; SHATTERGLASS
                    </button>
                    <p id="shatterglass-timer" class="text-adt-muted small mt-2">
                        Temporarily unlock sovereign paths for manual human repair. Logged to ADS.
                    </p>
                </div>
            </div>
        </div>

        <div class="section-title">Recent Denials</div>
        <div class="card card-adt">
            <div class="card-body p-0">
                <div id="recent-denials-container" class="timeline-container" style="max-height: 300px;">
                    <!-- Denials injected by JS -->
                    <div class="p-3 text-center text-adt-muted" style="font-size:0.8rem;">
                        Checking for denials...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Shatterglass Activation Modal -->
<div class="modal fade modal-adt" id="shatterglassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">&#9888; EMERGENCY OVERRIDE</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <p class="fw-bold mb-3">Shattering the glass disables sovereign path protection for 15 minutes.</p>
                <p class="text-adt-muted small mb-4">
                    This action is logged to the ADS and requires human confirmation. 
                    Manual changes to config files will be permitted during this window.
                </p>
                
                <div class="mb-4">
                    <label class="form-label-adt">Type SHATTERGLASS to confirm</label>
                    <input type="text" id="shatter-confirm-input" class="form-control-adt text-center border-danger" placeholder="SHATTERGLASS">
                </div>

                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-adt-secondary" data-bs-dismiss="modal">Abort</button>
                    <button id="btn-shatter-confirm" class="btn btn-danger" onclick="activateShatterglass()">Confirm Shatter</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Jurisdiction Modal -->
<div class="modal fade modal-adt" id="editRoleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Jurisdiction: <span id="edit-role-name" class="text-adt-accent"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editRoleForm">
                <input type="hidden" id="edit-role-id">
                <div class="modal-body">
                    <div class="mb-4">
                        <label class="form-label-adt">Jurisdiction Paths</label>
                        <div id="paths-input-container" class="mb-2">
                            <!-- Path inputs injected by JS -->
                        </div>
                        <button type="button" class="btn btn-sm btn-adt-secondary" onclick="addPathInput()">+ Add Path</button>
                    </div>

                    <div class="mb-4">
                        <label class="form-label-adt">Allowed Actions (Role-Wide)</label>
                        <div class="d-flex gap-3 flex-wrap">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="action-edit" value="edit">
                                <label class="form-check-label" for="action-edit">edit</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="action-patch" value="patch">
                                <label class="form-check-label" for="action-patch">patch</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="action-create" value="create">
                                <label class="form-check-label" for="action-create">create</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="action-delete" value="delete">
                                <label class="form-check-label" for="action-delete">delete</label>
                            </div>
                        </div>
                        <p class="text-adt-muted small mt-2">Note: Specs may further restrict these actions.</p>
                    </div>

                    <div class="mb-0">
                        <label class="form-label-adt">Active Spec Bindings</label>
                        <div id="specs-select-container" class="d-flex flex-wrap gap-2">
                            <!-- Specs injected by JS -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-adt">
                    <button type="button" class="btn btn-sm btn-adt-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-adt-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Lock Confirmation Modal -->
<div class="modal fade modal-adt" id="lockConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="mb-3 text-adt-amber" style="font-size:2rem;">&#9888;</div>
                <h6 class="mb-3">Confirm Governance Lock</h6>
                <p class="text-adt-muted small mb-4">
                    Locking <strong id="lock-role-display"></strong> will prevent all accidental human edits to its jurisdiction via this UI.
                </p>
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-sm btn-adt-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-sm btn-adt-primary" id="btn-confirm-lock">Lock Role</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentRoles = {};
let allSpecs = [];

async function loadGovernance() {
    try {
        const [rolesRes, specsRes, conflictsRes] = await Promise.all([
            fetch('/api/governance/roles'),
            fetch('/api/specs'),
            fetch('/api/governance/conflicts')
        ]);
        
        const rolesData = await rolesRes.json();
        currentRoles = rolesData.roles;
        
        const specsData = await specsRes.json();
        allSpecs = specsData.specs;
        
        const conflictsData = await conflictsRes.json();
        renderConflicts(conflictsData.conflicts);
        
        renderRoleCards(currentRoles);
    } catch (err) {
        console.error('Failed to load governance data:', err);
    }
}

async function loadEnforcement() {
    try {
        const res = await fetch('/api/governance/enforcement');
        const data = await res.json();
        
        const badge = document.getElementById('enforcement-mode-badge');
        badge.innerText = (data.mode || '--').toUpperCase();
        badge.className = 'badge-adt ' + (data.mode === 'production' ? 'badge-completed' : 'badge-pending');
        
        const indicator = document.getElementById('dttp-indicator');
        indicator.className = 'status-dot ' + (data.status === 'active' ? 'dot-green' : 'dot-red');
        
        document.getElementById('dttp-status-text').innerText = data.status === 'active' ? 
            'DTTP Service Active on :5002' : 'DTTP Service OFFLINE';
            
        // Protected paths
        const pathsList = document.getElementById('protected-paths-list');
        pathsList.innerHTML = '';
        if (data.protected_paths) {
            const ul = document.createElement('ul');
            ul.className = 'list-unstyled small text-adt-muted mb-0';
            
            if (data.protected_paths.sovereign) {
                const li = document.createElement('li');
                li.innerHTML = `<span class="text-adt-red fw-bold">Sovereign (Tier 1):</span> ${data.protected_paths.sovereign.join(', ')}`;
                ul.appendChild(li);
            }
            if (data.protected_paths.constitutional) {
                const li = document.createElement('li');
                li.innerHTML = `<span class="text-adt-amber fw-bold">Constitutional (Tier 2):</span> ${data.protected_paths.constitutional.join(', ')}`;
                ul.appendChild(li);
            }
            pathsList.appendChild(ul);
        }
        
        // Recent Denials
        const denialsContainer = document.getElementById('recent-denials-container');
        denialsContainer.innerHTML = '';
        if (data.recent_denials && data.recent_denials.length > 0) {
            data.recent_denials.reverse().forEach(event => {
                const item = document.createElement('div');
                item.className = 'event-item event-denied p-2 border-bottom border-adt';
                item.style.backgroundColor = 'transparent';
                item.innerHTML = `
                    <div class="event-meta" style="font-size:0.65rem;">${event.ts.substring(11, 19)} &middot; ${event.role}</div>
                    <div class="event-body" style="font-size:0.75rem;">${event.description}</div>
                `;
                denialsContainer.appendChild(item);
            });
        } else {
            denialsContainer.innerHTML = '<div class="p-3 text-center text-adt-muted" style="font-size:0.8rem;">No recent denials.</div>';
        }
        
    } catch (err) {
        console.error('Failed to load enforcement status:', err);
    }
}

function renderRoleCards(roles) {
    const container = document.getElementById('role-cards-container');
    container.innerHTML = '';
    
    Object.entries(roles).forEach(([name, config]) => {
        const col = document.createElement('div');
        col.className = 'col-12';
        
        const roleDisplayName = name.replace('_', ' ').toUpperCase();
        const statusBadge = config.locked ? 
            '<span class="badge-adt badge-denied">LOCKED</span>' : 
            '<span class="badge-adt badge-completed">ACTIVE</span>';
            
        col.innerHTML = `
            <div class="card card-adt">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="fw-bold text-adt-accent">${roleDisplayName}</span>
                        <span class="ms-3">${statusBadge}</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="editRole('${name}')" ${config.locked ? 'disabled' : ''}>Edit</button>
                        <button class="btn btn-sm ${config.locked ? 'btn-adt-primary' : 'btn-adt-secondary'}" onclick="toggleLock('${name}')">
                            ${config.locked ? 'Unlock' : 'Lock'}
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="form-label-adt">Jurisdiction</div>
                            <div class="text-adt-muted small" style="word-break: break-all;">
                                ${config.paths.join(', ') || 'No paths assigned.'}
                            </div>
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <div class="form-label-adt">Allowed Actions</div>
                            <div class="text-adt-muted small">
                                ${config.action_types.join(', ') || 'None'}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-label-adt">Specs</div>
                            <div class="text-adt-muted small">
                                ${config.specs.join(', ') || 'None'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(col);
    });
}

function renderConflicts(conflicts) {
    const container = document.getElementById('conflicts-container');
    const list = document.getElementById('conflicts-list');
    list.innerHTML = '';
    
    if (conflicts && conflicts.length > 0) {
        container.classList.remove('d-none');
        conflicts.forEach(c => {
            const li = document.createElement('li');
            li.innerHTML = `&#9888; ${c.message}`;
            list.appendChild(li);
        });
    } else {
        container.classList.add('d-none');
    }
}

function editRole(name) {
    const config = currentRoles[name];
    document.getElementById('edit-role-name').innerText = name.replace('_', ' ');
    document.getElementById('edit-role-id').value = name;
    
    const pathsContainer = document.getElementById('paths-input-container');
    pathsContainer.innerHTML = '';
    config.paths.forEach(path => addPathInput(path));
    
    ['edit', 'patch', 'create', 'delete'].forEach(action => {
        document.getElementById('action-' + action).checked = config.action_types.includes(action);
    });
    
    // Specs list - Make them clickable (SPEC-026)
    const specsContainer = document.getElementById('specs-select-container');
    specsContainer.innerHTML = '';
    allSpecs.forEach(spec => {
        const badge = document.createElement('div');
        const isActive = config.specs.includes(spec.id);
        badge.className = `badge-adt spec-toggle-badge ${isActive ? 'badge-completed active' : 'btn-adt-secondary'} p-2` ;
        badge.style.cursor = 'pointer';
        badge.dataset.specId = spec.id;
        badge.innerHTML = `${spec.id}`;
        badge.onclick = () => {
            badge.classList.toggle('badge-completed');
            badge.classList.toggle('active');
            badge.classList.toggle('btn-adt-secondary');
        };
        specsContainer.appendChild(badge);
    });
    
    const myModal = new bootstrap.Modal(document.getElementById('editRoleModal'));
    myModal.show();
}

function addPathInput(value = '') {
    const container = document.getElementById('paths-input-container');
    const div = document.createElement('div');
    div.className = 'd-flex gap-2 mb-2';
    div.innerHTML = `
        <input type="text" class="form-control-adt" value="${value}" placeholder="path/to/dir/">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">&times;</button>
    `;
    container.appendChild(div);
}

document.getElementById('editRoleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const role = document.getElementById('edit-role-id').value;
    const config = currentRoles[role];
    
    const pathInputs = document.querySelectorAll('#paths-input-container input');
    const paths = Array.from(pathInputs).map(i => i.value.trim()).filter(v => v !== '');
    
    const actions = ['edit', 'patch', 'create', 'delete'].filter(a => 
        document.getElementById('action-' + a).checked
    );

    // Get selected specs from UI
    const selectedSpecs = Array.from(document.querySelectorAll('.spec-toggle-badge.active'))
                               .map(b => b.dataset.specId);
    
    try {
        // 1. Update jurisdiction paths and actions
        const res = await fetch(`/api/governance/roles/${role}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paths, action_types: actions })
        });
        
        if (!res.ok) {
            const data = await res.json();
            alert('Error updating jurisdiction: ' + data.error);
            return;
        }

        // 2. Update Spec bindings if they changed
        // This is a bit complex because spec bindings are stored in config/specs.json per spec.
        // We need to identify which specs were added and which were removed.
        const originalSpecs = config.specs;
        const added = selectedSpecs.filter(s => !originalSpecs.includes(s));
        const removed = originalSpecs.filter(s => !selectedSpecs.includes(s));

        for (const specId of [...added, ...removed]) {
            // Fetch current spec roles first to avoid wiping others
            const sRes = await fetch(`/api/specs/${specId}`);
            if (!sRes.ok) continue;
            const sData = await sRes.json();
            let roles = sData.roles || [];
            
            if (added.includes(specId)) {
                if (!roles.includes(role)) roles.push(role);
            } else {
                roles = roles.filter(r => r !== role);
            }

            await fetch(`/api/governance/specs/${specId}/roles`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ roles, action_types: actions }) // Sync actions too
            });
        }
        
        bootstrap.Modal.getInstance(document.getElementById('editRoleModal')).hide();
        loadGovernance();
        alert('Governance configuration updated and synced.');
    } catch (err) {
        alert('Failed to save changes: ' + err.message);
    }
});

async function toggleLock(name) {
    const config = currentRoles[name];
    if (config.locked) {
        // Unlock
        if (confirm(`Unlock governance for ${name}?`)) {
            await setRoleLock(name, false);
        }
    } else {
        document.getElementById('lock-role-display').innerText = name.replace('_', ' ');
        const modal = new bootstrap.Modal(document.getElementById('lockConfirmModal'));
        document.getElementById('btn-confirm-lock').onclick = async () => {
            await setRoleLock(name, true);
            modal.hide();
        };
        modal.show();
    }
}

async function setRoleLock(name, locked) {
    try {
        const res = await fetch(`/api/governance/roles/${name}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ locked, unlock: !locked })
        });
        if (res.ok) {
            loadGovernance();
        } else {
            const data = await res.json();
            alert('Error: ' + data.error);
        }
    } catch (err) {
        alert('Failed to update lock state');
    }
}

function openShatterglass() {
    document.getElementById('shatter-confirm-input').value = '';
    new bootstrap.Modal(document.getElementById('shatterglassModal')).show();
}

async function activateShatterglass() {
    const input = document.getElementById('shatter-confirm-input').value;
    if (input !== 'SHATTERGLASS') {
        alert('Confirmation text mismatch.');
        return;
    }

    try {
        const res = await fetch('/api/governance/shatter', { method: 'POST' });
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('shatterglassModal')).hide();
            startShatterTimer(900); // 15 minutes
            alert('Shatterglass ACTIVATED. Window open for 15 minutes.');
        } else {
            const data = await res.json();
            alert('Error: ' + data.error);
        }
    } catch (err) {
        // Fallback for demo/missing endpoint
        bootstrap.Modal.getInstance(document.getElementById('shatterglassModal')).hide();
        startShatterTimer(900);
    }
}

function startShatterTimer(seconds) {
    const btn = document.getElementById('btn-shatterglass');
    const label = document.getElementById('shatterglass-timer');
    btn.disabled = true;
    btn.className = 'btn btn-lg w-100 btn-danger fw-bold';
    
    const interval = setInterval(() => {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        btn.innerText = `SHATTERED (${m}:${s < 10 ? '0' : ''}${s})`;
        
        if (seconds <= 0) {
            clearInterval(interval);
            btn.disabled = false;
            btn.innerText = '&#9889; SHATTERGLASS';
            btn.className = 'btn btn-lg w-100 btn-outline-danger fw-bold';
            label.innerText = 'Temporarily unlock sovereign paths for manual human repair. Logged to ADS.';
            loadEnforcement();
        }
        seconds--;
    }, 1000);
}

async function loadSCRs() {
    try {
        const res = await fetch('/api/governance/sovereign-requests?status=pending');
        if (!res.ok) return;
        const data = await res.json();
        const scrs = data.requests || [];
        
        const section = document.getElementById('scr-section');
        const badge = document.getElementById('scr-count-badge');
        
        if (scrs.length > 0) {
            section.classList.remove('d-none');
            badge.innerText = scrs.length;
            renderSCRCards(scrs);
        } else {
            section.classList.add('d-none');
        }
    } catch (err) {
        // Silently fail if endpoint doesn't exist yet
    }
}

function renderSCRCards(scrs) {
    const container = document.getElementById('scr-container');
    container.innerHTML = '';
    
    scrs.forEach(scr => {
        const col = document.createElement('div');
        col.className = 'col-12';
        
        const agentColor = scr.agent.toLowerCase().includes('claude') ? 'var(--adt-blue)' : 'var(--adt-green)';
        
        let diffHtml = '';
        if (scr.change_type === 'patch' && scr.patch) {
            diffHtml = `
                <div class="diff-viewer mt-2 p-2 rounded" style="background:rgba(0,0,0,0.2); font-family:monospace; font-size:0.75rem; border:1px solid var(--border-adt);">
                    <div class="text-danger">-${scr.patch.old_string}</div>
                    <div class="text-success">+${scr.patch.new_string}</div>
                </div>
            `;
        } else if (scr.change_type === 'json_merge') {
            diffHtml = `
                <div class="diff-viewer mt-2 p-2 rounded" style="background:rgba(0,0,0,0.2); font-family:monospace; font-size:0.75rem; border:1px solid var(--border-adt);">
                    <div class="text-adt-muted">Merge JSON:</div>
                    <pre class="mb-0 text-success">${JSON.stringify(scr.merge_data, null, 2)}</pre>
                </div>
            `;
        } else {
            diffHtml = `<div class="text-adt-muted small mt-2">Change type: ${scr.change_type}</div>`;
        }

        col.innerHTML = `
            <div class="card card-adt border-amber shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center" style="background:rgba(255, 171, 0, 0.05);">
                    <div>
                        <span class="text-adt-amber fw-bold">${scr.id}</span> &middot; 
                        <span class="text-white">${scr.target_path}</span>
                    </div>
                    <div class="small text-adt-muted">${new Date(scr.ts).toLocaleString()}</div>
                </div>
                <div class="card-body">
                    <p class="mb-2" style="font-size:0.9rem;">"${scr.description}"</p>
                    <div class="d-flex align-items-center mb-3">
                        <div class="badge-adt me-2" style="background:${agentColor}; color:white;">${scr.agent}</div>
                        <div class="text-adt-muted small">${scr.role}</div>
                    </div>
                    ${diffHtml}
                    <div class="d-flex gap-2 justify-content-end mt-4">
                        <button class="btn btn-sm btn-outline-danger" onclick="handleSCR('${scr.id}', 'reject')">Reject</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="handleSCR('${scr.id}', 'edit')">Edit & Authorize</button>
                        <button class="btn btn-sm btn-adt-primary" onclick="handleSCR('${scr.id}', 'authorize')">Authorize Change</button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(col);
    });
}

async function handleSCR(id, action) {
    if (action === 'reject') {
        const reason = prompt('Reason for rejection:');
        if (reason === null) return;
        
        await fetch(`/api/governance/sovereign-requests/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'reject', reason })
        });
    } else if (action === 'authorize') {
        if (!confirm('Authorize this sovereign change?')) return;
        
        await fetch(`/api/governance/sovereign-requests/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'authorize' })
        });
    } else if (action === 'edit') {
        alert('Edit functionality coming soon.');
        return;
    }
    
    loadSCRs();
}

// Initial render
document.addEventListener('DOMContentLoaded', () => {
    loadGovernance();
    loadEnforcement();
    loadSCRs();
    // Refresh enforcement & SCRs every 10s
    setInterval(() => {
        loadEnforcement();
        loadSCRs();
    }, 10000);
});
</script>
{% endblock %}