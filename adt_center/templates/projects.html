{% extends "base.html" %}

{% block title %}Projects - ADT Operational Center{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Governed Projects</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#initProjectModal">
                <i class="bi bi-plus-lg"></i> Register Project
            </button>
        </div>
    </div>

    <div class="row" id="projects-grid">
        {% for name, project in projects.items() %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 bg-dark text-light border-secondary">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-truncate" title="{{ name }}">{{ name }}</h5>
                    {% if project.is_framework %}
                    <span class="badge bg-primary">Framework</span>
                    {% else %}
                    <span class="badge bg-secondary">Project</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <p class="card-text text-muted small text-truncate" title="{{ project.path }}">
                        <i class="bi bi-folder"></i> {{ project.path }}
                    </p>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="dttp-status" data-project="{{ name }}" data-port="{{ project.dttp_port }}">
                            <span class="status-dot unknown"></span>
                            <span class="status-text ms-1">Checking...</span>
                        </span>
                        <small class="text-muted">Port: {{ project.dttp_port }}</small>
                    </div>

                    <div class="row text-center mb-3">
                        <div class="col">
                            <h6 class="mb-0 ads-count" id="ads-count-{{ name }}">-</h6>
                            <small class="text-muted">Events</small>
                        </div>
                        <div class="col">
                            <h6 class="mb-0 tasks-count" id="tasks-count-{{ name }}">-</h6>
                            <small class="text-muted">Tasks</small>
                        </div>
                        <div class="col">
                            <h6 class="mb-0 specs-count" id="specs-count-{{ name }}">-</h6>
                            <small class="text-muted">Specs</small>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="/?project={{ name }}" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-speedometer2"></i> Open Dashboard
                        </a>
                        <div class="btn-group">
                            <button class="btn btn-outline-success btn-sm btn-start" onclick="manageProject('{{ name }}', 'start')" id="btn-start-{{ name }}">
                                <i class="bi bi-play-fill"></i> Start
                            </button>
                            <button class="btn btn-outline-danger btn-sm btn-stop" onclick="manageProject('{{ name }}', 'stop')" id="btn-stop-{{ name }}">
                                <i class="bi bi-stop-fill"></i> Stop
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer border-secondary text-muted small">
                    Registered: {{ project.registered_at[:10] }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Init Project Modal -->
<div class="modal fade" id="initProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Initialize ADT Governance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="init-project-form">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="project-path" class="form-label">Project Path (Absolute)</label>
                        <input type="text" class="form-control bg-black text-light border-secondary" id="project-path" name="path" placeholder="/home/user/Projects/my-app" required>
                        <div class="form-text text-muted">The directory where _cortex/ will be created.</div>
                    </div>
                    <div class="mb-3">
                        <label for="project-name" class="form-label">Project Name (Optional)</label>
                        <input type="text" class="form-control bg-black text-light border-secondary" id="project-name" name="name" placeholder="my-app">
                        <div class="form-text text-muted">Defaults to directory name.</div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="project-detect" name="detect" checked>
                        <label class="form-check-input-label" for="project-detect">
                            Auto-detect project type & suggest jurisdictions
                        </label>
                    </div>
                    <div id="init-feedback" class="alert d-none"></div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="btn-submit-init">Initialize</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.status-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
}
.status-dot.online { background-color: #28a745; box-shadow: 0 0 5px #28a745; }
.status-dot.offline { background-color: #dc3545; }
.status-dot.unknown { background-color: #6c757d; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.dttp-status').forEach(el => {
        const project = el.dataset.project;
        checkStatus(project, el);
        loadStats(project);
    });

    const initForm = document.getElementById('init-project-form');
    if (initForm) {
        initForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const feedback = document.getElementById('init-feedback');
            const submitBtn = document.getElementById('btn-submit-init');
            
            const data = {
                path: document.getElementById('project-path').value,
                name: document.getElementById('project-name').value || null,
                detect: document.getElementById('project-detect').checked
            };

            feedback.classList.remove('d-none', 'alert-danger', 'alert-success');
            feedback.classList.add('alert-info');
            feedback.textContent = 'Initializing...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/projects/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    feedback.classList.remove('alert-info');
                    feedback.classList.add('alert-success');
                    feedback.textContent = `Success! Project '${result.project.name}' initialized. Reloading...`;
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    throw new Error(result.error || 'Initialization failed');
                }
            } catch (err) {
                feedback.classList.remove('alert-info');
                feedback.classList.add('alert-danger');
                feedback.textContent = err.message;
                submitBtn.disabled = false;
            }
        });
    }
});

async function manageProject(name, action) {
    const btn = document.getElementById(`btn-${action}-${name}`);
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const response = await fetch(`/api/projects/${name}/${action}`, { method: 'POST' });
        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || `Failed to ${action} project`);
        
        // Refresh status after action
        const statusEl = document.querySelector(`.dttp-status[data-project="${name}"]`);
        await checkStatus(name, statusEl);
    } catch (err) {
        alert(err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
    }
}

async function checkStatus(project, el) {
    const dot = el.querySelector('.status-dot');
    const text = el.querySelector('.status-text');
    const startBtn = document.getElementById(`btn-start-${project}`);
    const stopBtn = document.getElementById(`btn-stop-${project}`);
    
    try {
        const response = await fetch(`/api/dttp/status?project=${project}`);
        const data = await response.json();
        
        if (response.ok && data.status !== 'offline') {
            dot.classList.remove('unknown', 'offline');
            dot.classList.add('online');
            text.textContent = 'Active';
            if (startBtn) startBtn.classList.add('disabled');
            if (stopBtn) stopBtn.classList.remove('disabled');
        } else {
            dot.classList.remove('unknown', 'online');
            dot.classList.add('offline');
            text.textContent = 'Offline';
            if (startBtn) startBtn.classList.remove('disabled');
            if (stopBtn) stopBtn.classList.add('disabled');
        }
    } catch (e) {
        dot.classList.remove('unknown', 'online');
        dot.classList.add('offline');
        text.textContent = 'Unreachable';
    }
}

async function loadStats(project) {
    try {
        const [tasksRes, specsRes, adsRes] = await Promise.all([
            fetch(`/api/tasks?project=${project}`),
            fetch(`/api/specs?project=${project}`),
            fetch(`/api/ads/events?project=${project}&limit=1`)
        ]);

        if (tasksRes.ok) {
            const data = await tasksRes.json();
            document.getElementById(`tasks-count-${project}`).textContent = data.tasks ? data.tasks.length : 0;
        }
        if (specsRes.ok) {
            const data = await specsRes.json();
            document.getElementById(`specs-count-${project}`).textContent = data.specs ? data.specs.length : 0;
        }
        if (adsRes.ok) {
            // Just verifying connectivity for now since we don't have a count endpoint
            document.getElementById(`ads-count-${project}`).textContent = 'âœ“';
        }
    } catch (e) {
        console.error(`Failed to load stats for ${project}`, e);
    }
}
</script>
{% endblock %}
